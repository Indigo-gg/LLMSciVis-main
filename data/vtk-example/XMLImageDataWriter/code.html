<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vtk.js XMLImageDataWriter</title>
</head>

<body>
    <div id="renderer"></div>

    <script type="text/javascript" src="https://unpkg.com/@babel/polyfill@7.0.0/dist/polyfill.js"></script>
    <script src="https://unpkg.com/vtk.js"></script>
    <script>

        // ----------------------------------------------------------------------------
        // Standard rendering code setup
        // ----------------------------------------------------------------------------

        const dataPath = 'http://kitware.github.io/vtk-js/data/volume/headsq.vti';
        const fullScreenRenderer = vtk.Rendering.Misc.vtkFullScreenRenderWindow.newInstance();
        const renderer = fullScreenRenderer.getRenderer();
        const renderWindow = fullScreenRenderer.getRenderWindow();

        const reader = vtk.IO.Core.vtkHttpDataSetReader.newInstance({ fetchGzip: true });

        const writer = vtk.IO.XML.vtkXMLImageDataWriter.newInstance();
        writer.setFormat(vtk.IO.XML.vtkXMLWriter.FormatTypes.BINARY);
        writer.setInputConnection(reader.getOutputPort());

        const writerReader = vtk.IO.XML.vtkXMLImageDataReader.newInstance();

        reader
            .setUrl(dataPath, { loadData: true })
            .then(() => {
                const fileContents = writer.write(reader.getOutputData());

                // Try to read it back.
                const textEncoder = new TextEncoder();
                writerReader.parseAsArrayBuffer(textEncoder.encode(fileContents));
                renderer.resetCamera();
                renderWindow.render();

                const blob = new Blob([fileContents], { type: 'text/plain' });
                const a = window.document.createElement('a');
                a.href = window.URL.createObjectURL(blob, { type: 'text/plain' });
                a.download = 'headsq.vti';
                a.text = 'Download';
                a.style.position = 'absolute';
                a.style.left = '50%';
                a.style.bottom = '10px';
                document.body.appendChild(a);
                a.style.background = 'white';
                a.style.padding = '5px';
            });

        const actor = vtk.Rendering.Core.vtkVolume.newInstance();
        const mapper = vtk.Rendering.Core.vtkVolumeMapper.newInstance();
        mapper.setSampleDistance(1.1);
        actor.setMapper(mapper);

        mapper.setInputConnection(writerReader.getOutputPort());

        // create color and opacity transfer functions
        const ctfun = vtk.Rendering.Core.vtkColorTransferFunction.newInstance();
        ctfun.addRGBPoint(200.0, 1.0, 1.0, 1.0);
        ctfun.addRGBPoint(2000.0, 0.0, 0.0, 0.0);
        const ofun = vtk.Common.DataModel.vtkPiecewiseFunction.newInstance();
        ofun.addPoint(200.0, 0.0);
        ofun.addPoint(1200.0, 0.2);
        ofun.addPoint(4000.0, 0.4);
        actor.getProperty().setRGBTransferFunction(0, ctfun);
        actor.getProperty().setScalarOpacity(0, ofun);
        actor.getProperty().setScalarOpacityUnitDistance(0, 4.5);
        // actor.getProperty().setInterpolationTypeToNearest();
        // actor.getProperty().setInterpolationTypeToFastLinear();
        actor.getProperty().setInterpolationTypeToLinear();

        renderer.addActor(actor);

        window.writer = writer;
        window.writerReader = writerReader;
        window.mapper = mapper;
        window.actor = actor;
        window.renderer = renderer;
        window.renderWindow = renderWindow;

    </script>

</body>

</html>