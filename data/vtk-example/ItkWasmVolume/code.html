<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vtk.js Isosurface Visualization</title>
    <link rel="stylesheet" href="https://kit.fontawesome.com/419a5ebb56.css" crossorigin="anonymous">
    <style>
        #renderer {
            width: 100%;
            height: 600px;
            background-color: #333;
        }
    </style>
</head>

<body>
    <div id="renderer"></div>
    <script src="https://unpkg.com/vtk.js"></script>
    <script src="https://unpkg.com/vtk.js/Sources/IO/Core/DataAccessHelper/LiteHttpDataAccessHelper.js"></script>
    <script>
        const vtkColorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction;
        const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
        const vtkPiecewiseFunction = vtk.Common.DataModel.vtkPiecewiseFunction;
        const vtkVolume = vtk.Rendering.Core.vtkVolume;
        const vtkVolumeMapper = vtk.Rendering.Core.vtkVolumeMapper;
        const vtkITKHelper = vtk.Common.DataModel.vtkITKHelper;
        // const vtkLiteHttpDataAccessHelper = vtk.IO.Core.DataAccessHelper.vtkLiteHttpDataAccessHelper;

        // ----------------------------------------------------------------------------
        // Standard rendering code setup
        // ----------------------------------------------------------------------------

        const fullScreenRenderer = vtkFullScreenRenderWindow.newInstance({
            background: [0, 0, 0],
        });
        const renderer = fullScreenRenderer.getRenderer();
        const renderWindow = fullScreenRenderer.getRenderWindow();

        const actor = vtkVolume.newInstance();
        const mapper = vtkVolumeMapper.newInstance();
        mapper.setSampleDistance(0.7);
        actor.setMapper(mapper);

        const ctfun = vtkColorTransferFunction.newInstance();
        ctfun.addRGBPoint(200.0, 0.4, 0.5, 0.0);
        ctfun.addRGBPoint(2000.0, 1.0, 1.0, 1.0);
        const ofun = vtkPiecewiseFunction.newInstance();
        ofun.addPoint(200.0, 0.0);
        ofun.addPoint(120.0, 0.3);
        ofun.addPoint(300.0, 0.6);
        actor.getProperty().setRGBTransferFunction(0, ctfun);
        actor.getProperty().setScalarOpacity(0, ofun);
        actor.getProperty().setScalarOpacityUnitDistance(0, 4.5);
        actor.getProperty().setInterpolationTypeToLinear();
        actor.getProperty().setUseGradientOpacity(0, true);
        actor.getProperty().setGradientOpacityMinimumValue(0, 15);
        actor.getProperty().setGradientOpacityMinimumOpacity(0, 0.0);
        actor.getProperty().setGradientOpacityMaximumValue(0, 100);
        actor.getProperty().setGradientOpacityMaximumOpacity(0, 1.0);
        actor.getProperty().setShade(true);
        actor.getProperty().setAmbient(0.2);
        actor.getProperty().setDiffuse(0.7);
        actor.getProperty().setSpecular(0.3);
        actor.getProperty().setSpecularPower(8.0);

        // ----------------------------------------------------------------------------
        // Example code
        // ----------------------------------------------------------------------------

        async function update() {
            const volumeArrayBuffer = await LiteHttpDataAccessHelper.fetchBinary(
                `https://data.kitware.com/api/v1/file/5d2a36ff877dfcc902fae6d9/download`
            );

            // Load the itk-wasm ESM module dynamically for the example.
            // This can also go in the HTML <head>.
            // Or `npm install @itk-wasm/image-io` and import it directly.
            const { readImage } = await import(
    // eslint-disable-next-line import/no-unresolved, import/extensions
    /* webpackIgnore: true */ 'https://cdn.jsdelivr.net/npm/@itk-wasm/image-io@1.1.0/dist/bundle/index-worker-embedded.min.js'
            );

            const { image: itkImage, webWorker } = await readImage({
                data: new Uint8Array(volumeArrayBuffer),
                path: 'knee.mha',
            });
            // Optionally terminate the web worker when it is no longer needed
            webWorker.terminate();

            const vtkImage = vtkITKHelper.convertItkToVtkImage(itkImage);

            mapper.setInputData(vtkImage);
            renderer.addVolume(actor);
            renderer.resetCamera();
            renderer.getActiveCamera().zoom(1.5);
            renderer.getActiveCamera().elevation(70);
            renderer.updateLightsGeometryToFollowCamera();
            renderWindow.render();
        }
        update();

        // -----------------------------------------------------------
        // Make some variables global so that you can inspect and
        // modify objects in your browser's developer console:
        // -----------------------------------------------------------

        window.mapper = mapper;
        window.actor = actor;
        window.ctfun = ctfun;
        window.ofun = ofun;
        window.renderer = renderer;
        window.renderWindow = renderWindow;

    </script>
</body>

</html>