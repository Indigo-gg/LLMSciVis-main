<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vtk.js Isosurface Visualization</title>
    <link rel="stylesheet" href="https://kit.fontawesome.com/419a5ebb56.css" crossorigin="anonymous">
    <style>
        #renderer {
            width: 100%;
            height: 600px;
            background-color: #333;
        }
    </style>
</head>

<body>
    <div id="renderer"></div>
    <script src="https://unpkg.com/vtk.js"></script>
    <!-- 设置vtk.js的favicon -->
    <script type="module" src="https://unpkg.com/vtk.js/favicon.js"></script>

    <!-- 加载WebGL和WebGPU的渲染模块 -->
    <script type="module" src="https://unpkg.com/vtk.js/Sources/Rendering/Profiles/Volume.js"></script>

    <!-- 强制DataAccessHelper访问各种数据源 -->
    <script type="module"
        src="https://unpkg.com/vtk.js/Sources/IO/Core/DataAccessHelper/HtmlDataAccessHelper.js"></script>
    <script type="module"
        src="https://unpkg.com/vtk.js/Sources/IO/Core/DataAccessHelper/HttpDataAccessHelper.js"></script>
    <script type="module"
        src="https://unpkg.com/vtk.js/Sources/IO/Core/DataAccessHelper/JSZipDataAccessHelper.js"></script>

    <script>
        const vtkFullScreenRenderWindow = vtk.Rendering.Misc.vtkFullScreenRenderWindow;
        const vtkHttpDataSetReader = vtk.IO.Core.vtkHttpDataSetReader;
        const vtkImageMapper = vtk.Rendering.Core.vtkImageMapper;
        const vtkImageSlice = vtk.Rendering.Core.vtkImageSlice;
        const path = 'http://kitware.github.io/vtk-js/data'

        // 引用HTML模板
        const controlPanel = `<table>
    <tr>
        <td>Slice I</td>
        <td>
            <input class='sliceI' type="range" min="0" max="2.0" step="1" value="1" />
        </td>
    </tr>
    <tr>
        <td>Slice J</td>
        <td>
            <input class='sliceJ' type="range" min="0" max="2.0" step="1" value="1" />
        </td>
    </tr>
    <tr>
        <td>Slice K</td>
        <td>
            <input class='sliceK' type="range" min="0" max="100" step="1" value="1" />
        </td>
    </tr>
    <tr>
        <td>Color level</td>
        <td>
            <input class='colorLevel' type="range" min="-3926" max="3926" step="1" value="1" />
        </td>
    </tr>
    <tr>
        <td>ColorWindow</td>
        <td>
            <input class='colorWindow' type="range" min="0" max="3926" step="1" value="1" />
        </td>
    </tr>
</table>
`;
        const fullScreenRenderWindow = vtkFullScreenRenderWindow.newInstance({
            background: [0, 0, 0],
        });
        const renderWindow = fullScreenRenderWindow.getRenderWindow();
        const renderer = fullScreenRenderWindow.getRenderer();
        fullScreenRenderWindow.addController(controlPanel);

        const imageActorI = vtkImageSlice.newInstance();
        const imageActorJ = vtkImageSlice.newInstance();
        const imageActorK = vtkImageSlice.newInstance();

        renderer.addActor(imageActorK);
        renderer.addActor(imageActorJ);
        renderer.addActor(imageActorI);

        function updateColorLevel(e) {
            const colorLevel = Number(
                (e ? e.target : document.querySelector('.colorLevel')).value
            );
            imageActorI.getProperty().setColorLevel(colorLevel);
            imageActorJ.getProperty().setColorLevel(colorLevel);
            imageActorK.getProperty().setColorLevel(colorLevel);
            renderWindow.render();
        }

        function updateColorWindow(e) {
            const colorLevel = Number(
                (e ? e.target : document.querySelector('.colorWindow')).value
            );
            imageActorI.getProperty().setColorWindow(colorLevel);
            imageActorJ.getProperty().setColorWindow(colorLevel);
            imageActorK.getProperty().setColorWindow(colorLevel);
            renderWindow.render();
        }

        const reader = vtkHttpDataSetReader.newInstance({
            fetchGzip: true,
        });
        reader
            .setUrl(`${path}/data/volume/headsq.vti`, { loadData: true })
            .then(() => {
                const data = reader.getOutputData();
                const dataRange = data.getPointData().getScalars().getRange();
                const extent = data.getExtent();

                const imageMapperK = vtkImageMapper.newInstance();
                imageMapperK.setInputData(data);
                imageMapperK.setKSlice(30);
                imageActorK.setMapper(imageMapperK);

                const imageMapperJ = vtkImageMapper.newInstance();
                imageMapperJ.setInputData(data);
                imageMapperJ.setJSlice(30);
                imageActorJ.setMapper(imageMapperJ);

                const imageMapperI = vtkImageMapper.newInstance();
                imageMapperI.setInputData(data);
                imageMapperI.setISlice(30);
                imageActorI.setMapper(imageMapperI);

                renderer.resetCamera();
                renderer.resetCameraClippingRange();
                renderWindow.render();

                ['.sliceI', '.sliceJ', '.sliceK'].forEach((selector, idx) => {
                    const el = document.querySelector(selector);
                    el.setAttribute('min', extent[idx * 2 + 0]);
                    el.setAttribute('max', extent[idx * 2 + 1]);
                    el.setAttribute('value', 30);
                });

                ['.colorLevel', '.colorWindow'].forEach((selector) => {
                    document.querySelector(selector).setAttribute('max', dataRange[1]);
                    document.querySelector(selector).setAttribute('value', dataRange[1]);
                });
                document
                    .querySelector('.colorLevel')
                    .setAttribute('value', (dataRange[0] + dataRange[1]) / 2);
                updateColorLevel();
                updateColorWindow();
            });

        document.querySelector('.sliceI').addEventListener('input', (e) => {
            imageActorI.getMapper().setISlice(Number(e.target.value));
            renderWindow.render();
        });

        document.querySelector('.sliceJ').addEventListener('input', (e) => {
            imageActorJ.getMapper().setJSlice(Number(e.target.value));
            renderWindow.render();
        });

        document.querySelector('.sliceK').addEventListener('input', (e) => {
            imageActorK.getMapper().setKSlice(Number(e.target.value));
            renderWindow.render();
        });

        document
            .querySelector('.colorLevel')
            .addEventListener('input', updateColorLevel);
        document
            .querySelector('.colorWindow')
            .addEventListener('input', updateColorWindow);

        window.fullScreen = fullScreenRenderWindow;
        window.imageActorI = imageActorI;
        window.imageActorJ = imageActorJ;
        window.imageActorK = imageActorK;

    </script>
</body>

</html>